--There are multiple antivirus softwares which are running on the systems and you have the data of how many malware they have detected  in each run.
--You need to find out how many malware each software has detected in their latest run and what is the difference
--between the number of malwares detected in latest run and the second last run for each software. 
--Please note that list only the softwares which have run for atleast 2 times and have detected atleast 10 malware in the latest run.


CREATE TABLE malware 
(
    software_id	INT,
    run_date	VARCHAR(512),
    malware_detected	INT
);

INSERT INTO malware (software_id, run_date, malware_detected) VALUES ('100', '2024-01-01 02:00:01', '12');
INSERT INTO malware (software_id, run_date, malware_detected) VALUES ('100', '2024-01-01 03:12:01', '15');
INSERT INTO malware (software_id, run_date, malware_detected) VALUES ('100', '2024-01-01 16:00:01', '9');
INSERT INTO malware (software_id, run_date, malware_detected) VALUES ('101', '2024-01-01 12:00:00', '9');
INSERT INTO malware (software_id, run_date, malware_detected) VALUES ('101', '2024-01-01 16:00:00', '10');
INSERT INTO malware (software_id, run_date, malware_detected) VALUES ('101', '2024-01-01 18:00:00', '12');
INSERT INTO malware (software_id, run_date, malware_detected) VALUES ('102', '2024-01-01 12:00:00', '14');

SELECT * FROM malware

WITH CTE_M AS(
SELECT *
,ROW_NUMBER() OVER (PARTITION BY software_id ORDER BY run_date DESC ) AS rn
FROM malware 
	),CTE_N AS (
SELECT  software_id
,SUM(CASE WHEN rn = 1 THEN malware_detected END ) AS latest_run_count	
,SUM(CASE WHEN rn = 2 THEN malware_detected END ) AS previous_run_count
FROM CTE_M 
--WHERE rn IN( 1, 2 )
GROUP BY software_id
HAVING COUNT(*) >= 2
		)
--SELECT * FROM CTE_N
SELECT software_id, latest_run_count
,(latest_run_count - previous_run_count ) AS difference_to_previous
FROM CTE_N
WHERE latest_run_count >= 10		